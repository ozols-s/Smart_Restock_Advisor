{% extends "base.html" %}

{% block title %}Управление заказами - Smart Restock{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">
{% endblock %}

{% block content %}
<div class="orders-container">
    <!-- Заголовок и кнопки -->
    <div class="orders-header">
        <div class="page-title">
            <h1><i class="fas fa-file-invoice"></i> Управление заказами</h1>
        </div>
    </div>

    <!-- Статистика по статусам -->
    <div class="orders-stats">
        {% set stats = namespace(pending=0, processing=0, shipped=0, delivered=0, cancelled=0) %}
        {% for order in orders %}
            {% if order.status == 'pending' %}{% set stats.pending = stats.pending + 1 %}
            {% elif order.status == 'processing' %}{% set stats.processing = stats.processing + 1 %}
            {% elif order.status == 'shipped' %}{% set stats.shipped = stats.shipped + 1 %}
            {% elif order.status == 'delivered' %}{% set stats.delivered = stats.delivered + 1 %}
            {% elif order.status == 'cancelled' %}{% set stats.cancelled = stats.cancelled + 1 %}
            {% endif %}
        {% endfor %}

        <div class="order-card pending">
            <div class="number">{{ stats.pending }}</div>
            <div class="label">Ожидают</div>
        </div>
        <div class="order-card processing">
            <div class="number">{{ stats.processing }}</div>
            <div class="label">В обработке</div>
        </div>
        <div class="order-card shipped">
            <div class="number">{{ stats.shipped }}</div>
            <div class="label">Отправлены</div>
        </div>
        <div class="order-card delivered">
            <div class="number">{{ stats.delivered }}</div>
            <div class="label">Доставлены</div>
        </div>
        <div class="order-card cancelled">
            <div class="number">{{ stats.cancelled }}</div>
            <div class="label">Отменены</div>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filters">
        <div class="filters-left">
            <select class="filter-select" id="statusFilter" onchange="filterOrders()">
                <option value="">Все статусы</option>
                <option value="pending">Ожидание</option>
                <option value="processing">В обработке</option>
                <option value="shipped">Отправлено</option>
                <option value="delivered">Доставлено</option>
                <option value="cancelled">Отменено</option>
            </select>

            <select class="filter-select" id="supplierFilter" onchange="filterOrders()">
                <option value="">Все поставщики</option>
                {% set suppliers_set = [] %}
                {% for order in orders %}
                    {% if order.supplier_id and order.supplier_id not in suppliers_set %}
                        {% set _ = suppliers_set.append(order.supplier_id) %}
                        <option value="{{ order.supplier_id }}">Поставщик {{ order.supplier_id }}</option>
                    {% endif %}
                {% endfor %}
            </select>

            <input type="date" class="filter-select" id="dateFrom" placeholder="От даты" onchange="filterOrders()">
            <input type="date" class="filter-select" id="dateTo" placeholder="До даты" onchange="filterOrders()">

            <button class="btn btn-outline" onclick="clearFilters()">
                <i class="fas fa-times"></i> Сбросить
            </button>
        </div>

        <div class="filters-right">
            <button class="btn btn-primary">
                <i class="fas fa-plus"></i> Создать заказ
            </button>
            <button class="btn" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>
    </div>

    <!-- Таблица -->
    {% if orders %}
    <div class="table-container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>№ Заказа</th>
                    <th>Поставщик</th>
                    <th>Товар</th>
                    <th>Кол-во</th>
                    <th>Сумма</th>
                    <th>Дата создания</th>
                    <th>Дата поставки</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr data-status="{{ order.status }}" data-supplier="{{ order.supplier_id }}"
                    data-date="{{ order.order_date.strftime('%Y-%m-%d') if order.order_date else '' }}">
                    <td><strong>{{ order.order_number or 'Без номера' }}</strong></td>
                    <td>Поставщик {{ order.supplier_id }}</td>
                    <td>{{ order.product_code or 'Не указан' }}</td>
                    <td>{{ order.quantity or 0 }}</td>
                    <td><strong>{{ "%.2f ₽"|format(order.total_amount) if order.total_amount else '0.00 ₽' }}</strong></td>
                    <td>
                        {% if order.order_date %}
                            {{ order.order_date.strftime('%d.%m.%Y') }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if order.expected_delivery %}
                            {{ order.expected_delivery.strftime('%d.%m.%Y') }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if order.status == 'pending' %}
                            <span class="order-status status-pending">Ожидание</span>
                        {% elif order.status == 'processing' %}
                            <span class="order-status status-processing">В обработке</span>
                        {% elif order.status == 'shipped' %}
                            <span class="order-status status-shipped">Отправлен</span>
                        {% elif order.status == 'delivered' %}
                            <span class="order-status status-delivered">Доставлен</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="order-status status-cancelled">Отменен</span>
                        {% else %}
                            <span class="order-status">{{ order.status or '—' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-view" title="Подробнее" onclick="viewOrder({{ order.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-edit" title="Изменить статус" onclick="editOrder({{ order.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Итоги -->
    <div class="table-footer">
        <div class="summary-info">
            <strong>Всего заказов:</strong> {{ orders|length }}
            <span style="margin: 0 15px">|</span>
            <strong>Общая сумма:</strong> {{ "%.2f ₽"|format(total_amount) }}
        </div>
    </div>

    {% else %}
    <!-- Сообщение, если нет заказов -->
    <div class="no-orders">
        <i class="fas fa-file-invoice"></i>
        <h3>Нет заказов</h3>
        <p>Добавьте первый заказ, чтобы начать работу</p>
        <button class="btn btn-primary" style="margin-top: 15px;">
            <i class="fas fa-plus"></i> Создать первый заказ
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterOrders() {
    const status = document.getElementById('statusFilter').value;
    const supplier = document.getElementById('supplierFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    const rows = document.querySelectorAll('.orders-table tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        let show = true;

        // Фильтр по статусу
        if (status && row.getAttribute('data-status') !== status) {
            show = false;
        }

        // Фильтр по поставщику
        if (supplier && row.getAttribute('data-supplier') !== supplier) {
            show = false;
        }

        // Фильтр по дате
        const rowDate = row.getAttribute('data-date');
        if (dateFrom && rowDate < dateFrom) {
            show = false;
        }
        if (dateTo && rowDate > dateTo) {
            show = false;
        }

        if (show) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Обновить статистику в заголовке
    const summary = document.querySelector('.summary-info');
    if (summary) {
        summary.innerHTML = `<strong>Показано:</strong> ${visibleCount} из {{ orders|length }} заказов`;
    }
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('supplierFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';

    const rows = document.querySelectorAll('.orders-table tbody tr');
    rows.forEach(row => row.style.display = '');

    const summary = document.querySelector('.summary-info');
    if (summary) {
        summary.innerHTML = `<strong>Всего заказов:</strong> {{ orders|length }} | <strong>Общая сумма:</strong> {{ "%.2f ₽"|format(total_amount) }}`;
    }
}

function viewOrder(orderId) {
    alert('Просмотр заказа #' + orderId);
    // Здесь будет переход к деталям заказа
}

function editOrder(orderId) {
    alert('Редактирование заказа #' + orderId);
    // Здесь будет изменение статуса заказа
}

// Установить сегодняшнюю дату как максимальную
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateFrom').max = today;
    document.getElementById('dateTo').max = today;
});
</script>
{% endblock %}