{% extends "base.html" %}

{% block title %}Аналитика продаж - Smart Restock{% endblock %}

{% block content %}
<div class="header">
    <div class="page-title">
        <h1><i class="fas fa-chart-line"></i> Аналитика продаж</h1>
    </div>
    <div class="header-actions">
        <select class="period-select" id="periodSelect">
            <option value="7">За последние 7 дней</option>
            <option value="30">За последние 30 дней</option>
            <option value="90">За последние 90 дней</option>
            <option value="365" selected>За последний год</option>
        </select>
        <button class="btn btn-primary" id="exportBtn">
            <i class="fas fa-download"></i> Экспорт отчета
        </button>
        <button class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> Обновить
        </button>
    </div>
</div>

<div class="metrics-grid">
    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Общий товарооборот</div>
            <div class="kpi-icon" style="background: rgba(52, 152, 219, 0.2); color: var(--secondary);">
                <i class="fas fa-money-bill-wave"></i>
            </div>
        </div>
        <div class="kpi-value" id="totalRevenue">Загрузка...</div>
        <div class="kpi-trend" id="revenueTrendContainer">
            <i class="fas fa-arrow-up"></i> <span id="revenueTrend">0%</span> с прошлого месяца
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Точность прогноза</div>
            <div class="kpi-icon" style="background: rgba(46, 204, 113, 0.2); color: var(--success);">
                <i class="fas fa-bullseye"></i>
            </div>
        </div>
        <div class="kpi-value" id="forecastAccuracy">97%</div>
        <div class="kpi-trend trend-up">
            <i class="fas fa-arrow-up"></i> <span id="accuracyTrend">2.1%</span> улучшение
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Средняя оборачиваемость</div>
            <div class="kpi-icon" style="background: rgba(243, 156, 18, 0.2); color: var(--warning);">
                <i class="fas fa-exchange-alt"></i>
            </div>
        </div>
        <div class="kpi-value" id="turnoverDays">Загрузка...</div>
        <div class="kpi-trend" id="turnoverTrendContainer">
            <i class="fas fa-arrow-down"></i> <span id="turnoverTrend">0 дней</span> улучшение
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <div class="kpi-title">Упущенная выручка</div>
            <div class="kpi-icon" style="background: rgba(231, 76, 60, 0.2); color: var(--danger);">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
        <div class="kpi-value" id="lostRevenue">Загрузка...</div>
        <div class="kpi-trend" id="lostRevenueTrendContainer">
            <i class="fas fa-arrow-down"></i> <span id="lostRevenueTrend">0%</span> снижение
        </div>
    </div>
</div>

<div class="chart-row">
    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">XYZ-анализ товаров</div>
            <div class="chart-subtitle">Категоризация по стабильности спроса</div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(52, 152, 219, 0.6);"></span>
                    <span>X - Стабильные</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(46, 204, 113, 0.6);"></span>
                    <span>Y - Средние</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(231, 76, 60, 0.6);"></span>
                    <span>Z - Непредсказуемые</span>
                </div>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="xyzAnalysisChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">ABC-анализ товаров</div>
            <div class="chart-subtitle">Распределение по вкладу в выручку</div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(52, 152, 219, 0.8);"></span>
                    <span>A - 80% выручки</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(46, 204, 113, 0.8);"></span>
                    <span>B - 15% выручки</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(241, 196, 15, 0.8);"></span>
                    <span>C - 5% выручки</span>
                </div>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="abcAnalysisChart"></canvas>
        </div>
    </div>
</div>

<div class="chart-row">
    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">Сезонность продаж</div>
            <div class="chart-subtitle">Распределение выручки по месяцам</div>
        </div>
        <div class="chart-wrapper">
            <canvas id="seasonalityChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">Топ-10 товаров по прибыльности</div>
            <div class="chart-subtitle">Наиболее эффективные позиции</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Товар</th>
                        <th>Выручка</th>
                        <th>Прибыль</th>
                        <th>Маржа</th>
                        <th>Оборачиваемость</th>
                    </tr>
                </thead>
                <tbody id="topProductsTable">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999; padding: 40px;">
                            <div class="spinner"></div>
                            <div style="margin-top: 10px;">Загрузка данных...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; color: #7f8c8d; font-size: 12px;">
    <i class="fas fa-database"></i>
    <span style="margin-left: 5px;">
        Данные обновлены: <span id="lastUpdate">только что</span> |
        Период: <span id="currentPeriodText">за последний год</span> |
        Товаров с продажами: <span id="activeProducts">0</span> из <span id="totalProducts">0</span>
    </span>
</div>

<style>
    .chart-wrapper {
        position: relative;
        height: 300px !important;
        width: 100% !important;
    }

    .chart-wrapper canvas {
        display: block !important;
        width: 100% !important;
        height: 300px !important;
        min-height: 300px !important;
    }

    #xyzAnalysisChart,
    #abcAnalysisChart,
    #seasonalityChart {
        max-width: 100% !important;
        max-height: 300px !important;
    }

    .chart-container {
        display: flex;
        flex-direction: column;
        height: 400px;
    }

    .chart-header {
        flex-shrink: 0;
    }

    .table-container {
        overflow-x: auto;
        height: 400px;
        display: flex;
        flex-direction: column;
    }

    .table-container table {
        min-width: 800px;
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Конфигурация Chart.js
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#666';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 4;

    let abcChart, xyzChart, seasonalityChart;
    let currentPeriod = 365;
    let lastUpdateTime = new Date();

    // Основная функция загрузки данных
    async function loadAnalyticsData(period = currentPeriod) {
        showLoading();

        try {
            const response = await fetch(`/api/analytics_data?period=${period}`);
            const data = await response.json();

            if (data.error) {
                showError('Ошибка загрузки данных: ' + data.error);
                return;
            }

            // Обновляем KPI метрики
            updateKPIMetrics(data.kpi_metrics || {}, data);

            // Строим графики
            createCharts(data);

            // Заполняем таблицу
            populateTopProductsTable(data.top_products || []);

            // Обновляем время последнего обновления
            updateLastUpdateTime();

            hideLoading();

        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            showError('Не удалось загрузить данные. Проверьте подключение к серверу.');
            hideLoading();
        }
    }

    // Функция обновления KPI карточек
    function updateKPIMetrics(metrics, data) {
        // Общий товарооборот
        if (metrics.total_revenue) {
            document.getElementById('totalRevenue').textContent = metrics.total_revenue;

            // Обновляем тренд выручки
            const revenueTrendContainer = document.getElementById('revenueTrendContainer');
            const revenueTrend = document.getElementById('revenueTrend');

            if (metrics.total_revenue_value) {
                const revenueValue = parseFloat(metrics.total_revenue_value) || 0;
                // Простая логика для тренда
                if (revenueValue > 0) {
                    revenueTrend.textContent = '6%';
                    revenueTrendContainer.className = 'kpi-trend trend-up';
                } else {
                    revenueTrend.textContent = '0%';
                    revenueTrendContainer.className = 'kpi-trend';
                }
            }
        }

        document.getElementById('forecastAccuracy').textContent = '92%';
        document.getElementById('accuracyTrend').textContent = '2.1%';

        if (metrics.turnover_days) {
            document.getElementById('turnoverDays').textContent = metrics.turnover_days;
            const turnoverTrend = document.getElementById('turnoverTrend');
            const turnoverTrendContainer = document.getElementById('turnoverTrendContainer');

            turnoverTrend.textContent = '3.2 дня';
            turnoverTrendContainer.className = 'kpi-trend trend-down';
        }

        // Упущенная выручка
        if (metrics.lost_revenue) {
            document.getElementById('lostRevenue').textContent = metrics.lost_revenue;
            const lostRevenueTrend = document.getElementById('lostRevenueTrend');
            const lostRevenueTrendContainer = document.getElementById('lostRevenueTrendContainer');

            lostRevenueTrend.textContent = '28%';
            lostRevenueTrendContainer.className = 'kpi-trend trend-down';
        }

        if (metrics.products_with_sales && metrics.total_products) {
            const withSales = parseInt(metrics.products_with_sales) || 0;
            const total = parseInt(metrics.total_products) || 0;

            document.getElementById('activeProducts').textContent = withSales;
            document.getElementById('totalProducts').textContent = total;
        }
    }

    // Функция создания графиков
    function createCharts(data) {
        // Уничтожаем старые графики если они есть
        [abcChart, xyzChart, seasonalityChart].forEach(chart => {
            if (chart) chart.destroy();
        });

        // 1. XYZ анализ (столбчатая диаграмма)
        if (data.xyz_analysis && document.getElementById('xyzAnalysisChart')) {
            const ctx = document.getElementById('xyzAnalysisChart').getContext('2d');
            xyzChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.xyz_analysis.labels,
                    datasets: [{
                        ...data.xyz_analysis.datasets[0],
                        borderWidth: 1,
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} товаров (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    const category = context.label;
                                    if (category.includes('X')) {
                                        return 'Стабильный спрос, низкая вариативность';
                                    } else if (category.includes('Y')) {
                                        return 'Средняя стабильность спроса';
                                    } else if (category.includes('Z')) {
                                        return 'Высокая вариативность спроса';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество товаров',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // 2. ABC анализ (круговая диаграмма)
        if (data.abc_analysis && document.getElementById('abcAnalysisChart')) {
            const ctx = document.getElementById('abcAnalysisChart').getContext('2d');
            abcChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.abc_analysis.labels,
                    datasets: [{
                        ...data.abc_analysis.datasets[0],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} товаров (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1000
                    }
                }
            });
        }

        // 3. Сезонность (линейный график)
        if (data.seasonality && document.getElementById('seasonalityChart')) {
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            seasonalityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.seasonality.labels,
                    datasets: [{
                        ...data.seasonality.datasets[0],
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(155, 89, 182, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${parseFloat(context.raw).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Доля выручки (%)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 5,
                            hoverRadius: 8
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }
    }

    // Функция заполнения таблицы топ товаров
    function populateTopProductsTable(products) {
        const tableBody = document.getElementById('topProductsTable');
        if (!tableBody) return;

        if (!products || products.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #999; padding: 40px;">
                        <i class="fas fa-box-open" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div style="margin-top: 10px;">Нет данных о продажах за выбранный период</div>
                    </td>
                </tr>
            `;
            return;
        }

        let rows = '';
        products.forEach((product, index) => {
            const profitMargin = product.profit_margin || 0;
            const revenue = product.revenue || 0;
            const profit = product.profit || 0;
            const quantity = product.quantity || 0;

            // цвет бейджа в зависимости от рентабельности
            let badgeClass = 'badge-info';
            let marginText = profitMargin.toFixed(1) + '%';

            if (profitMargin > 40) {
                badgeClass = 'badge-success';
                marginText = '✓ ' + marginText;
            } else if (profitMargin > 25) {
                badgeClass = 'badge-warning';
            } else if (profitMargin < 10) {
                badgeClass = 'badge-danger';
                marginText = '⚠ ' + marginText;
            }

            // оборачиваемость
            let turnover = 'Н/Д';
            if (quantity > 0 && revenue > 0) {
                const avgPrice = revenue / quantity;
                const dailySales = quantity / 30;
                turnover = dailySales > 0 ? Math.round(quantity / dailySales) + ' дн.' : 'Н/Д';
            }

            rows += `
                <tr>
                    <td style="font-weight: 600; color: #666; width: 40px;">${index + 1}</td>
                    <td>
                        <div style="font-weight: 600; font-size: 14px;">${product.product_name || product.product_code}</div>
                        <div style="font-size: 12px; color: #888;">Код: ${product.product_code}</div>
                    </td>
                    <td style="font-weight: 600;">
                        ${formatCurrency(revenue)} ₽
                    </td>
                    <td style="font-weight: 600; color: var(--success);">
                        ${formatCurrency(profit)} ₽
                    </td>
                    <td>
                        <span class="badge ${badgeClass}" style="font-size: 11px; padding: 4px 8px;">
                            ${marginText}
                        </span>
                    </td>
                    <td style="font-size: 13px; color: var(--text);">
                        ${turnover}
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = rows;
    }

    // Обновление времени последнего обновления
    function updateLastUpdateTime() {
        lastUpdateTime = new Date();
        const timeString = lastUpdateTime.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('lastUpdate').textContent = timeString;
    }

    // Вспомогательные функции
    function formatCurrency(value) {
        if (value >= 1000000) {
            return (value / 1000000).toFixed(1).replace('.', ',') + ' млн';
        } else if (value >= 1000) {
            return (value / 1000).toFixed(0) + ' тыс';
        }
        return new Intl.NumberFormat('ru-RU').format(Math.round(value));
    }

    function showLoading() {
        const loaders = document.querySelectorAll('.chart-wrapper, .table-container');
        loaders.forEach(loader => {
            loader.classList.add('loading');
        });

        // Индикатор загрузки в кнопке обновления
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;
        }
    }

    function hideLoading() {
        const loaders = document.querySelectorAll('.chart-wrapper, .table-container');
        loaders.forEach(loader => {
            loader.classList.remove('loading');
        });

        // Нормальный вид кнопке обновления
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Обновить';
            refreshBtn.disabled = false;
        }
    }

    function showError(message) {
        // уведомление
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-notification';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        // Стили
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(errorDiv);

        // Автоматически удаляем через 5 секунд
        setTimeout(() => {
            if (errorDiv.parentElement) {
                errorDiv.remove();
            }
        }, 5000);
    }

    // Обработчики событий
    document.getElementById('periodSelect').addEventListener('change', function(e) {
        currentPeriod = parseInt(e.target.value);
        const periodText = this.options[this.selectedIndex].text;
        document.getElementById('currentPeriodText').textContent = periodText.toLowerCase();
        loadAnalyticsData(currentPeriod);
    });

    document.getElementById('exportBtn').addEventListener('click', function() {
        alert('Функция экспорта отчета будет доступна в последующих версиях.');
    });

    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadAnalyticsData(currentPeriod);
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadAnalyticsData(currentPeriod);

        // CSS анимации
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .chart-container {
                animation: fadeIn 0.5s ease;
            }

            .kpi-card {
                animation: fadeIn 0.3s ease;
            }

            .error-notification button {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .error-notification button:hover {
                opacity: 1;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}